name: ISO 42001 Governance & Fairness Audit

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  governance-audit:
    name: "ISO 42001 & NIST AI RMF Check"
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx duckduckgo-search

    # Module 2: ISO 42001 (Policy Automation)
    # Ensure that OPA policies are synchronized with documentation (Plan -> Do)
    - name: "Module 2: Generate OPA Policies (Plan -> Do)"
      run: |
        echo "Running Deontic Policy Extractor..."
        python scripts/deontic_policy_extractor.py

        # Verify if git shows changes (meaning policies were out of sync)
        if [[ `git status --porcelain config/opa/policies.rego` ]]; then
          echo "❌ OPA policies are out of sync with banking_regs.md!"
          echo "Please run 'python scripts/deontic_policy_extractor.py' and commit the result."
          exit 1
        else
          echo "✅ OPA policies are up to date."
        fi

    # Module 1: SR 11-7 (Outcomes Analysis)
    # Run the automated auditor on mock traces to verify audit logic integrity
    - name: "Module 1: Verify Audit Logic (Outcomes Analysis)"
      run: |
        echo "Running Automated Trace Auditor..."
        python scripts/automated_auditor.py

    # Module 3: NIST AI RMF (Fairness Testing)
    # Run the new fairness test suite
    - name: "Module 3: Run Fairness & Bias Tests (NIST Measure)"
      env:
        # Mock env vars if needed for tests
        GOOGLE_API_KEY: "mock-key-for-ci"
      run: |
        echo "Running NIST AI RMF Fairness Suite..."
        pytest tests/fairness/test_fairness.py -v
