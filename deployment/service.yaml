apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: neuro-cybernetic-agent
  annotations:
    run.googleapis.com/launch-stage: BETA
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/execution-environment: gen2
        run.googleapis.com/startup-cpu-boost: "true"
    spec:
      serviceAccountName: financial-advisor-sa
      containers:
        # 1. The Brain (Your Existing Agent)
        - name: agent-brain
          image: gcr.io/PROJECT_ID/financial-advisor:latest
          ports:
            - containerPort: 8080
          env:
            - name: POLICY_URL
              value: "http://localhost:8181/v1/data/banking/governance"
          resources:
            limits:
              cpu: "2"
              memory: "2Gi"

        # 2. The Guard (OPA Sidecar)
        - name: policy-guard
          image: openpolicyagent/opa:latest
          args:
            - "run"
            - "--server"
            - "--addr=localhost:8181" # Bind to localhost for sharing with agent
            - "/policies" # Load all policies in the directory
          ports:
            - containerPort: 8181
          resources:
            limits:
              cpu: "0.5"
              memory: "128Mi"
          volumeMounts:
            - name: policy-volume
              mountPath: /policies
      volumes:
        - name: policy-volume
          secret:
            secretName: governance-policy
            items:
              - key: latest
                path: policy.rego
