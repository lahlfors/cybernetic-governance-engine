apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: system-2-governed-agent
  annotations:
    run.googleapis.com/launch-stage: BETA
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/execution-environment: gen2
        run.googleapis.com/startup-cpu-boost: "true"
    spec:
      serviceAccountName: financial-advisor-sa
      containers:
      # --- CONTAINER 1: The Agent (Ingress) ---
      # This container runs the LangGraph logic and talks to localhost:9000
      - name: ingress-agent
        image: gcr.io/PROJECT_ID/financial-advisor:latest
        ports:
          - containerPort: 8080
        env:
          - name: GUARD_URL
            value: "http://127.0.0.1:9000"
          # Standard env vars injected by deployment script

      # --- CONTAINER 2: The Sidecar Guard ---
      # This container runs the Policy/Safety logic
      - name: policy-sidecar
        image: gcr.io/PROJECT_ID/policy-guard:latest
        ports:
          - containerPort: 9000
        env:
          - name: BANKING_API_KEY
            valueFrom:
              secretKeyRef:
                name: banking-core-secrets
                key: api-key
        resources:
            limits:
              cpu: "1"
              memory: "512Mi"
