apiVersion: apps/v1
kind: Deployment
metadata:
  name: governed-financial-advisor
  namespace: governance-stack
  labels:
    app: governed-financial-advisor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: governed-financial-advisor
  template:
    metadata:
      labels:
        app: governed-financial-advisor
    spec:
      serviceAccountName: advisor-sa # Explicit SA for Workload Identity
      volumes:
        - name: policy-volume
          secret:
            secretName: finance-policy-rego
        - name: opa-config-volume
          secret:
            secretName: opa-configuration

      containers:
        # Main Agent Container
        - name: ingress-agent
          image: gcr.io/laah-cybernetics/financial-advisor:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: ENV
              value: "production"
            - name: PORT
              value: "8080"
            - name: GOOGLE_CLOUD_PROJECT
              value: "laah-cybernetics"
            - name: GOOGLE_CLOUD_LOCATION
              value: "northamerica-northeast2"
            - name: VLLM_BASE_URL
              value: "http://vllm-service.governance-stack.svc.cluster.local:8000/v1"
            - name: OPA_URL
              value: "http://localhost:8181/v1/data/finance/allow"
            - name: DEPLOY_TIMESTAMP
              value: "20260127214321"
          # Load secrets from K8s Secret (optional, fallback to GSM)
          envFrom:
            - secretRef:
                name: advisor-secrets
                optional: true
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "1000m"
              memory: "2Gi"

        # OPA Sidecar
        - name: opa
          image: openpolicyagent/opa:latest-static
          ports:
            - containerPort: 8181
          args:
            - "run"
            - "--server"
            - "--addr=localhost:8181"
            - "--config-file=/config/opa_config.yaml"
            - "/policies/finance_policy.rego"

          volumeMounts:
            - name: policy-volume
              mountPath: /policies/finance_policy.rego
              subPath: finance_policy.rego
              readOnly: true
            - name: opa-config-volume
              mountPath: /config
              readOnly: true
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "250m"
              memory: "256Mi"

---
apiVersion: v1
kind: Service
metadata:
  name: governed-financial-advisor
  namespace: governance-stack
spec:
  type: LoadBalancer
  selector:
    app: governed-financial-advisor
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
