# NeMo Guardrails Flows - Colang 2.x

import core
import llm

flow user ask analysis
  user said "Analyze AAPL"
  or user said "analyze microsoft"
  or user said "evaluate the risk of TSLA"
  or user said "recommend a trade"
  or user said "what is the sentiment for GOOGL"
  or user said "how is the market doing"
  or user said "Analyze the portfolio"

flow main
  activate self check input
  activate self check output
  activate check_authorization
  activate check_latency
  activate check_financial_risk

flow greeting
  user expressed greeting
  bot express greeting

flow user expressed greeting
  user said "hello" or user said "hi" or user said "hey" or user said "Hi" or user said "Hello"

flow bot express greeting
  bot say "Hello! I'm your financial advisor assistant. How can I help you today?"

flow financial_analysis
  user ask analysis
  $bot_message = await InvokeVllmFallbackAction(content=$last_user_message)
  if $bot_message
    bot say $bot_message

flow catch_all
  match UserMessage(content=regex("(?i).*"))
  $bot_message = await InvokeVllmFallbackAction(content=$last_user_transcript)
  if $bot_message
    bot say $bot_message

flow check_authorization
  user said "execute trade"
  $allowed = await CheckApprovalTokenAction()
  if not $allowed
    bot refuse to respond
    abort

flow check_latency
  user said "execute trade"
  $allowed = await CheckDataLatencyAction()
  if not $allowed
    bot refuse to respond
    abort

flow check_financial_risk
  user said "execute trade"
  $drawdown_ok = await CheckDrawdownLimitAction()
  if not $drawdown_ok
    bot refuse to respond
    abort
  $slippage_ok = await CheckSlippageRiskAction()
  if not $slippage_ok
    bot refuse to respond
    abort
