# NeMo Guardrails Flows - Colang 2.x
# Actions are registered programmatically, so no import needed

import core
import llm

# action execute_vllm_fallback



# Main flow - required entry point for Colang 2.x
flow main
  activate llm continuation
  activate greeting
  activate catch_all
  activate check_authorization
  activate check_latency
  activate check_financial_risk

flow greeting
  user expressed greeting
  bot express greeting

flow user expressed greeting
  user said "hello" or user said "hi" or user said "hey" or user said "Hi" or user said "Hello"

flow bot express greeting
  bot say "Hello! I'm your financial advisor assistant. How can I help you today?"

flow financial_analysis
  match UtteranceUserAction.Finished(final_transcript=regex("(?i)analyze.*"))
  or match UtteranceUserAction.Finished(final_transcript=regex("(?i)recommend.*"))
  or match UtteranceUserAction.Finished(final_transcript=regex("(?i)evaluate.*"))
  or match UtteranceUserAction.Finished(final_transcript=regex("(?i)what is.*"))
  or match UtteranceUserAction.Finished(final_transcript=regex("(?i)how.*"))
  $bot_message = "DEBUG: Logic bypassed action (financial_analysis)."
  bot say $bot_message

flow catch_all
  match UtteranceUserAction.Finished(final_transcript=regex("(?i).*"))
  # $bot_message = await execute_vllm_fallback(content=$last_user_message)
  $bot_message = "DEBUG: Logic bypassed action (catch_all)."
  if $bot_message
    bot say $bot_message
  # else
  #   bot say "I apologize, but I encountered an issue generating a response."

# flow bot continue
#   $bot_message = "DEBUG: Logic bypassed action."
#   if $bot_message
#     bot say $bot_message
#   else
#     bot say "I apologize, but I encountered an issue generating a response."

flow check_authorization
  user said "execute trade"
  $allowed = await check_approval_token()
  if not $allowed
    bot refuse to respond
    abort

flow check_latency
  user said "execute trade"
  $allowed = await check_data_latency()
  if not $allowed
    bot refuse to respond
    abort

flow check_financial_risk
  user said "execute trade"
  $drawdown_ok = await check_drawdown_limit()
  if not $drawdown_ok
    bot refuse to respond
    abort
  $slippage_ok = await check_slippage_risk()
  if not $slippage_ok
    bot refuse to respond
    abort

flow generate_bot_message
  $bot_message = await GenerateBotMessageAction()
