{
  "components": {
    "comp-policy-transpilation-op": {
      "executorLabel": "exec-policy-transpilation-op",
      "inputDefinitions": {
        "parameters": {
          "generated_rules_path": {
            "parameterType": "STRING"
          },
          "ucas": {
            "parameterType": "STRUCT"
          }
        }
      },
      "outputDefinitions": {
        "parameters": {
          "Output": {
            "parameterType": "STRING"
          }
        }
      }
    },
    "comp-risk-discovery-op": {
      "executorLabel": "exec-risk-discovery-op",
      "inputDefinitions": {
        "parameters": {
          "output_gcs_path": {
            "parameterType": "STRING"
          },
          "trading_strategy": {
            "parameterType": "STRING"
          }
        }
      },
      "outputDefinitions": {
        "parameters": {
          "Output": {
            "parameterType": "STRUCT"
          }
        }
      }
    },
    "comp-rule-deployment-op": {
      "executorLabel": "exec-rule-deployment-op",
      "inputDefinitions": {
        "parameters": {
          "generated_code": {
            "parameterType": "STRING"
          },
          "target_env": {
            "parameterType": "STRING"
          }
        }
      }
    }
  },
  "deploymentSpec": {
    "executors": {
      "exec-policy-transpilation-op": {
        "container": {
          "args": [
            "--executor_input",
            "{{$}}",
            "--function_to_execute",
            "policy_transpilation_op"
          ],
          "command": [
            "sh",
            "-c",
            "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'google-adk' 'pydantic'  &&  python3 -m pip install --quiet --no-warn-script-location 'kfp==2.15.2' '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"$0\" \"$@\"\n",
            "sh",
            "-ec",
            "program_path=$(mktemp -d)\n\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\n_KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
            "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import *\n\ndef policy_transpilation_op(\n    ucas: dict,\n    generated_rules_path: str\n) -> str:\n    \"\"\"\n    Component 2: Policy Transpiler.\n    Converts UCAs into Python Actions.\n    Logic Inlined.\n    \"\"\"\n    import logging\n\n    from pydantic import BaseModel\n\n    logger = logging.getLogger(\"PolicyTranspiler\")\n    logger.info(\"\u2699\ufe0f Transpiling Policies...\")\n\n    # --- INLINED SCHEMA ---\n    class ConstraintLogic(BaseModel):\n        variable: str\n        operator: str\n        threshold: str\n        condition: str | None = None\n\n    class ProposedUCA(BaseModel):\n        category: str\n        hazard: str\n        description: str\n        constraint_logic: ConstraintLogic\n\n    class PolicyTranspiler:\n        def generate_nemo_action(self, uca: ProposedUCA) -> str:\n            logger.info(f\"Transpiling UCA: {uca.description}\")\n            logic = uca.constraint_logic\n\n            if logic.variable == \"order_size\" or \"volume\" in logic.threshold:\n                threshold_multiplier = logic.threshold.split(\"*\")[0].strip()\n                if not threshold_multiplier.replace('.', '', 1).isdigit():\n                    threshold_multiplier = \"0.01\"\n                return f\"def check_slippage_risk(context, event): return True # {uca.hazard}\"\n\n            if logic.variable == \"latency\":\n                limit = logic.threshold\n                return f\"\"\"\ndef check_data_latency(context: Dict[str, Any] = {{}}, event: Dict[str, Any] = {{}}) -> bool:\n    '''Enforces {uca.hazard}: Blocks trades if data latency > {limit}ms.'''\n    current_latency = 50 # Mock\n    if current_latency > {limit}: return False\n    return True\n\"\"\"\n            return f\"# No template found for UCA: {uca.description}\"\n\n        def transpile_policy(self, ucas: list[ProposedUCA]) -> str:\n            code_blocks = [\"# AUTOMATICALLY GENERATED BY GOVERNANCE TRANSPILER\", \"\"]\n            for uca in ucas:\n                code_blocks.append(self.generate_nemo_action(uca))\n            return \"\\n\".join(code_blocks)\n\n    try:\n        raw_ucas = ucas.get(\"ucas\", [])\n        proposed_ucas = [ProposedUCA(**u) for u in raw_ucas]\n\n        transpiler = PolicyTranspiler()\n        code_content = transpiler.transpile_policy(proposed_ucas)\n\n        logger.info(\"\u2705 Transpilation Complete.\")\n        return code_content\n\n    except Exception as e:\n        logger.error(f\"Transpilation Failed: {e}\")\n        raise e\n\n"
          ],
          "image": "python:3.11"
        }
      },
      "exec-risk-discovery-op": {
        "container": {
          "args": [
            "--executor_input",
            "{{$}}",
            "--function_to_execute",
            "risk_discovery_op"
          ],
          "command": [
            "sh",
            "-c",
            "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'google-adk' 'pydantic' 'langchain-google-genai' 'python-dotenv'  &&  python3 -m pip install --quiet --no-warn-script-location 'kfp==2.15.2' '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"$0\" \"$@\"\n",
            "sh",
            "-ec",
            "program_path=$(mktemp -d)\n\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\n_KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
            "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import *\n\ndef risk_discovery_op(\n    trading_strategy: str,\n    output_gcs_path: str\n) -> dict:\n    \"\"\"\n    Component 1: Risk Analysis (A2 Discovery).\n    Runs the Risk Analyst agent to identify UCAs.\n    Logic is inlined to allow running on standard Python images on Vertex AI.\n    \"\"\"\n    import asyncio\n    import logging\n\n    from google.adk import Agent\n    from google.adk.tools import transfer_to_agent\n    from pydantic import BaseModel, Field\n\n    # --- INLINED DEPENDENCIES ---\n\n    # From src.utils.prompt_utils\n    class Part(BaseModel):\n        text: str | None = None\n    class Content(BaseModel):\n        parts: list[Part]\n    class PromptData(BaseModel):\n        model: str\n        contents: list[Content]\n    class Prompt(BaseModel):\n        prompt_data: PromptData\n\n    # From src.agents.risk_analyst.agent\n    class ConstraintLogic(BaseModel):\n        variable: str = Field(description=\"The variable to check (e.g., 'order_size', 'drawdown', 'latency')\")\n        operator: str = Field(description=\"Comparison operator (e.g., '<', '>', '==')\")\n        threshold: str = Field(description=\"Threshold value or reference (e.g., '0.01 * daily_volume', '200')\")\n        condition: str | None = Field(description=\"Pre-condition (e.g., 'order_type == MARKET')\")\n\n    class ProposedUCA(BaseModel):\n        category: str = Field(description=\"STPA Category: Unsafe Action, Wrong Timing, Not Provided, Stopped Too Soon\")\n        hazard: str = Field(description=\"The specific financial hazard (e.g., 'H-4: Slippage > 1%')\")\n        description: str = Field(description=\"Description of the unsafe control action\")\n        constraint_logic: ConstraintLogic = Field(description=\"Structured logic for the transpiler\")\n\n    class RiskAssessment(BaseModel):\n        risk_level: str = Field(description=\"Overall risk level: Low, Medium, High, Critical\")\n        identified_ucas: list[ProposedUCA] = Field(description=\"List of specific Financial UCAs identified\")\n        analysis_text: str = Field(description=\"Detailed textual analysis of risks\")\n\n    MODEL_REASONING = \"gemini-2.5-pro\" # Hardcoded for safety in pipeline\n\n    RISK_ANALYST_PROMPT_TEXT = \"\"\"\nRole: You are the 'Risk Discovery Agent' (A2 System).\nYour goal is to analyze the proposed trading execution plan and identify specific FINANCIAL UNSAFE CONTROL ACTIONS (UCAs) using STPA methodology.\n\nInput:\n- provided_trading_strategy\n- execution_plan_output (JSON)\n- user_risk_attitude\n\nTask:\nAnalyze the plan for these 4 specific Hazard Types and define UCAs if risk exists:\n\n1. Unsafe Action Provided (Insolvency/Drawdown):\n   - Check if the strategy risks hitting a hard drawdown limit (e.g., > 4.5% daily).\n   - UCA: \"Agent executes buy_order when daily_drawdown > 4.5%.\"\n   - Logic: variable=\"drawdown\", operator=\">\", threshold=\"4.5\", condition=\"action=='BUY'\"\n\n2. Wrong Timing (Stale Data/Front-running):\n   - Check if the strategy relies on ultra-low latency or is sensitive to stale data.\n   - UCA: \"Agent executes market_order when tick_timestamp is older than 200ms.\"\n   - Logic: variable=\"latency\", operator=\">\", threshold=\"200\", condition=\"order_type=='MARKET'\"\n\n3. Wrong Order (Liquidity/Slippage):\n   - Check if order size is too large for the asset's volume.\n   - UCA: \"Agent submits market_order where size > 1% of average_daily_volume.\"\n   - Logic: variable=\"order_size\", operator=\">\", threshold=\"0.01 * daily_volume\", condition=\"order_type=='MARKET'\"\n\n4. Stopped Too Soon (Atomic Execution Risk):\n   - Check if the strategy requires multi-leg execution (e.g., spreads).\n   - UCA: \"Agent fails to complete leg_2 within 1 second of leg_1.\"\n   - Logic: variable=\"time_delta_legs\", operator=\">\", threshold=\"1.0\", condition=\"strategy=='MULTI_LEG'\"\n\nOutput:\nReturn a structured JSON object (RiskAssessment) containing the list of identified UCAs with their structured `constraint_logic`.\n\"\"\"\n\n    # Initialize Agent\n    risk_analyst_agent = Agent(\n        model=MODEL_REASONING,\n        name=\"risk_analyst_agent\",\n        instruction=RISK_ANALYST_PROMPT_TEXT,\n        output_key=\"risk_assessment_output\",\n        tools=[transfer_to_agent],\n        output_schema=RiskAssessment,\n        generate_content_config={\n            \"response_mime_type\": \"application/json\"\n        }\n    )\n\n    # --- EXECUTION ---\n\n    logger = logging.getLogger(\"RiskDiscovery\")\n    logger.info(f\"Analyzing strategy: {trading_strategy}\")\n\n    agent_input = {\n        \"provided_trading_strategy\": trading_strategy,\n        \"execution_plan_output\": {\n            \"plan_id\": \"pipeline_execution\",\n            \"steps\": [],\n            \"risk_factors\": []\n        },\n        \"user_risk_attitude\": \"Balanced\"\n    }\n\n    logger.info(\"\ud83e\udde0 Invoking Risk Agent (Inlined)...\")\n\n    try:\n        async def run_agent():\n            return await risk_analyst_agent.invoke(agent_input)\n\n        result = asyncio.run(run_agent())\n        ucas = [uca.model_dump() for uca in result.identified_ucas]\n\n        logger.info(f\"\u2705 Identified {len(ucas)} UCAs.\")\n        return {\"ucas\": ucas}\n\n    except Exception as e:\n        logger.error(f\"Risk Discovery Failed: {e}\")\n        # In a real scenario we might fail, but for demo continuity we might return empty\n        # But failing is safer for observability.\n        raise e\n\n"
          ],
          "image": "python:3.11"
        }
      },
      "exec-rule-deployment-op": {
        "container": {
          "args": [
            "--executor_input",
            "{{$}}",
            "--function_to_execute",
            "rule_deployment_op"
          ],
          "command": [
            "sh",
            "-c",
            "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'kfp==2.15.2' '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"$0\" \"$@\"\n",
            "sh",
            "-ec",
            "program_path=$(mktemp -d)\n\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\n_KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
            "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import *\n\ndef rule_deployment_op(\n    generated_code: str,\n    target_env: str\n):\n    \"\"\"\n    Component 3: Rule Deployment.\n    \"\"\"\n    import logging\n    logger = logging.getLogger(\"RuleDeployment\")\n    logger.info(f\"\ud83d\ude80 Deploying rules to {target_env}...\")\n    print(\"--- DEPLOYED RULES ---\")\n    print(generated_code)\n    print(\"----------------------\")\n\n"
          ],
          "image": "python:3.11"
        }
      }
    }
  },
  "pipelineInfo": {
    "description": "Automated Green Stack Governance: Discovery -> Transpilation -> Enforcement",
    "name": "green-stack-governance-loop"
  },
  "root": {
    "dag": {
      "tasks": {
        "policy-transpilation-op": {
          "cachingOptions": {
            "enableCache": true
          },
          "componentRef": {
            "name": "comp-policy-transpilation-op"
          },
          "dependentTasks": [
            "risk-discovery-op"
          ],
          "inputs": {
            "parameters": {
              "generated_rules_path": {
                "runtimeValue": {
                  "constant": "gs://bucket/rules.py"
                }
              },
              "ucas": {
                "taskOutputParameter": {
                  "outputParameterKey": "Output",
                  "producerTask": "risk-discovery-op"
                }
              }
            }
          },
          "taskInfo": {
            "name": "policy-transpilation-op"
          }
        },
        "risk-discovery-op": {
          "cachingOptions": {
            "enableCache": true
          },
          "componentRef": {
            "name": "comp-risk-discovery-op"
          },
          "inputs": {
            "parameters": {
              "output_gcs_path": {
                "runtimeValue": {
                  "constant": "gs://bucket/risks.json"
                }
              },
              "trading_strategy": {
                "componentInputParameter": "trading_strategy"
              }
            }
          },
          "taskInfo": {
            "name": "risk-discovery-op"
          }
        },
        "rule-deployment-op": {
          "cachingOptions": {
            "enableCache": true
          },
          "componentRef": {
            "name": "comp-rule-deployment-op"
          },
          "dependentTasks": [
            "policy-transpilation-op"
          ],
          "inputs": {
            "parameters": {
              "generated_code": {
                "taskOutputParameter": {
                  "outputParameterKey": "Output",
                  "producerTask": "policy-transpilation-op"
                }
              },
              "target_env": {
                "componentInputParameter": "target_env"
              }
            }
          },
          "taskInfo": {
            "name": "rule-deployment-op"
          }
        }
      }
    },
    "inputDefinitions": {
      "parameters": {
        "target_env": {
          "defaultValue": "production",
          "isOptional": true,
          "parameterType": "STRING"
        },
        "trading_strategy": {
          "defaultValue": "Momentum Strategy",
          "isOptional": true,
          "parameterType": "STRING"
        }
      }
    }
  },
  "schemaVersion": "2.1.0",
  "sdkVersion": "kfp-2.15.2"
}